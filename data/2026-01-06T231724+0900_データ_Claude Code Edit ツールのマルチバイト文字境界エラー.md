# Claude Code Edit ツールのマルチバイト文字境界エラー

## 発生したエラー

```
thread '<unnamed>' (3825953) panicked at /rustc/ed61e7d7e242494fb7057f2657300d9e77bb4fcb/library/core/src/str/mod.rs:833:21:
byte index 47 is not a char boundary; it is inside 'す' (bytes 45..48) of `で評価すべきだと述べられています。能力を評価する3つの軸は、`
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
fatal runtime error: failed to initiate panic, error 5, aborting
```

## エラーの原因

### 技術的な詳細

このエラーは Rust の文字列処理における**文字境界（char boundary）エラー**です。

**問題の本質**:
- 日本語などのマルチバイト文字（UTF-8）は1文字が複数バイトで構成されている
- 例: 「す」は3バイト（bytes 45..48）で表現される
- Rust の文字列スライス操作でバイト単位で切ろうとすると、文字の途中で切断されてしまう
- これは UTF-8 の仕様上、無効な操作となる

**エラーメッセージの解読**:
```
byte index 47 is not a char boundary; it is inside 'す' (bytes 45..48)
```
- バイトインデックス 47 で文字列を切ろうとした
- しかし 47 は「す」という文字の途中（45〜48バイト）
- 文字境界ではないため、パニックが発生

### Claude Code における発生箇所

エラーは **Edit ツールの実行後の表示処理**で発生しました。

**処理の流れ**:
1. Edit ツールでファイルを編集 ✅ **成功**
2. ファイルへの書き込み ✅ **成功**
3. 編集結果の diff 生成・表示 ❌ **ここでクラッシュ**

つまり、**ファイル自体は正しく更新されている**が、その後の表示処理（おそらく diff の生成やスニペットの切り出し）で文字境界を考慮しない処理が行われ、クラッシュしました。

## 影響範囲

### 実害

- ❌ Claude Code プロセスが異常終了（abort）
- ❌ ユーザー体験の悪化（作業が中断される）

### 実害なし

- ✅ **ファイル編集は成功している**（最も重要）
- ✅ 編集内容は正しく保存されている
- ✅ データの破損や損失は発生していない

実際、クラッシュ後の system-reminder で確認すると、編集内容は正しく反映されていました：

```markdown
23→• **出典の解説**：[[2026-01-05T222614+0900_データ_おい、辞めるな|元資料]] では、自分の実力は絶好調の時ではなく**「調子が悪い時に出せるアウトプット」**で評価すべきだと述べられています。能力を評価する3つの軸は、**「技術力」「推進力（ビジネス課題解決など）」「影響力（チームへの貢献など）」**です。
```

## 根本原因の分析

### Claude Code の内部バグ

これは **Claude Code の Rust コード内のバグ**です。

**推測される問題箇所**:
1. diff 生成時のスニペット切り出し処理
2. 表示用のテキスト整形処理
3. 固定バイト数でのプレビュー生成

これらの処理で、文字境界を考慮せずにバイト単位でスライスしている可能性が高いです。

**正しい実装**:
```rust
// ❌ 間違い（バイト単位で切断）
let snippet = &text[0..47];  // 文字の途中で切れる可能性

// ✅ 正しい（文字境界を考慮）
let snippet = text.chars().take(20).collect::<String>();
// または
let snippet = &text[..text.char_indices().nth(20).unwrap().0];
```

### なぜ日本語で顕在化するか

**ASCII 文字の場合**:
- 1文字 = 1バイト
- どこで切っても文字境界になる
- エラーが発生しない

**日本語（UTF-8）の場合**:
- 1文字 = 3バイト（ひらがな、カタカナ、漢字）
- バイト単位で切ると文字の途中になる可能性が高い
- エラーが発生しやすい

つまり、このバグは**日本語などのマルチバイト文字を使う環境でのみ顕在化**します。

## 対策

### 短期的な対策（ユーザー側での回避策）

Claude Code の内部バグなので、完全な回避は困難ですが、以下の方法で発生頻度を下げられます：

1. **編集範囲を小さくする**
   - 一度に大量の日本語テキストを編集しない
   - old_string と new_string を最小限にする

2. **編集後のクラッシュを想定する**
   - クラッシュしても**ファイルは正しく更新されている**ことを理解する
   - Claude Code を再起動して作業を続行する

3. **連続編集時の工夫**
   - 1つのファイルを複数回に分けて編集する場合、各編集後に Read で確認
   - クラッシュしても次の編集箇所が分かるようにする

### 中長期的な対策（Claude Code への報告）

このバグは **Claude Code の開発チームに報告すべき**です。

**報告先**:
```
https://github.com/anthropics/claude-code/issues
```

**報告内容**:
- エラーメッセージ全文
- 再現手順（日本語を含む Edit ツールの使用）
- 期待される動作（文字境界を考慮した処理）
- 影響範囲（ファイルは更新されているが表示処理でクラッシュ）

## 学び

### Rust における文字列処理の基本

**Rust の文字列は UTF-8**:
- `String` と `&str` は常に有効な UTF-8 である必要がある
- バイト単位での操作は文字境界を考慮しなければならない
- 文字境界を跨ぐスライスは `panic!` を引き起こす

**安全な文字列操作**:
```rust
// 文字単位でのイテレーション
for ch in text.chars() { ... }

// 文字境界を考慮したスライス
text.char_indices()  // (バイト位置, 文字) のイテレータ

// 文字数での制限
text.chars().take(n).collect::<String>()
```

### マルチバイト文字環境でのテスト重要性

**国際化（i18n）の観点**:
- ASCII だけでテストしても、マルチバイト環境でのバグは見つからない
- 日本語、中国語、アラビア語などでのテストが必須
- 特に文字列処理は要注意

**Claude Code の品質向上への示唆**:
- 日本語環境でのテストが不足している可能性
- 文字境界を考慮しない処理が残存している
- より多様な文字セットでのテストが必要

## まとめ

**このエラーは**:
- ✅ Claude Code の内部バグである
- ✅ ファイル更新は成功している（実害は最小限）
- ✅ 日本語などのマルチバイト文字環境で顕在化する
- ✅ 表示処理の段階でクラッシュする

**対処法**:
1. **即座の対応**: クラッシュしてもファイルは更新されているので、再起動して続行
2. **回避策**: 編集範囲を小さくする
3. **長期的**: Claude Code 開発チームに報告

**教訓**:
- Rust の文字列処理では文字境界を常に意識する
- 国際化を考慮したテストが重要
- ツールのバグを理解し、適切に対処することが重要
